# Subhag EMBRION - Backend Dockerfile
# AI inference server with PyTorch and CLIP

FROM python:3.11-slim

# System dependencies
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsm6 \     libxext6 \     libxrender-dev \     libgomp1 \    libglib2.0-0 \    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Python dependencies
COPY embryo_ai/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir transformers pillow

# Copy application code
COPY embryo_ai/ ./embryo_ai/

# Pre-download CLIP model (cached in volume)
RUN python -c "from transformers import CLIPProcessor, CLIPModel; \
    CLIPModel.from_pretrained('openai/clip-vit-base-patch32'); \
    CLIPProcessor.from_pretrained('openai/clip-vit-base-patch32')"

WORKDIR /app/embryo_ai

# Start application
# We use a shell command to ensure download_models runs before the app starts
CMD python download_models.py && python main.py
